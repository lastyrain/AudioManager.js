(function(f){function j(){}function h(a,c,b){this.context=a;this.urlList=c;this.onload=b;this.bufferList=[];this.loadCount=0}function e(a){a=a||{};l||console.warn("not support user media");void 0===a.autoLoop&&(a.autoLoop=!0);this.context=null;this.sources={};this.analyser={};this.state={};this.fps=a.fps||24;this.autoLooop=!!a.autoLoop;this.ffSize=a.ffSize||2048;this.onEnterFrame=a.onEnterFrame||g;this.onInit=a.onInit||g;this.onMicInitSuccess=a.onMicInitSuccess||g;this.onMicInitFaild=a.onMicInitFaild||
g;this.onLoaded=a.onLoaded||g;this.useMicrophone=!!a.useMicrophone;this.isReady=this.isLoop=!1;this.buffers=null}function m(a,c,b,d){var k=this.context.createBufferSource();k.buffer=this.buffers.bufferList[c];k.loop=b;this.state[a]={index:c,sound:d,playing:!1};return k}var g=function(){},l;l=!!(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);h.prototype.loadBuffer=function(a,c){var b=this,d=new XMLHttpRequest;d.open("GET",
a,!0);d.responseType="arraybuffer";d.onload=function(){b.context.decodeAudioData(d.response,function(d){if(d){if(b.bufferList[c]=d,++b.loadCount===b.urlList.length)b.onload(b.bufferList)}else f.alert("error decoding file data: "+a)},function(a){console.error("decodeAudioData error",a)})};d.onerror=function(){f.alert("BufferLoader: XHR error")};d.send()};h.prototype.load=function(){for(var a=0;a<this.urlList.length;++a)this.loadBuffer(this.urlList[a],a)};e.prototype.init=function(){var a=this;a.context=
new f.AudioContext;if(a.useMicrophone)navigator.getUserMedia({audio:!0},function(c){a.micInitSuccess(c)},function(c){a.micInitFaild(c)});else if("function"===typeof a.onInit)a.onInit();return a};e.prototype.micInitSuccess=function(a){var c=this.context.createAnalyser();c.ffSize=this.ffSize;this.sources.mic=this.context.createMediaStreamSource(a);this.analyser.mic={a:c,d:new Uint8Array(this.ffSize/2),getByteFrequencyData:function(){this.a.getByteFrequencyData(this.d);return this.d}};this.sources.mic.connect(c);
if("function"===typeof this.onMicInitSuccess)this.onMicInitSuccess();this.isReady=!0;this.autoLooop&&(this.isLoop=!0,this.enterFrame())};e.prototype.micInitFaild=function(a){console.log("reject",a);if("function"===typeof this.onMicInitFaild)this.onMicInitFaild()};e.prototype.load=function(a){var c=this,b=null,b=f.Utils;if(a instanceof Array)b=a,c.sources=[],c.analyser=[];else{c.sources={};c.analyser={};b=b.values(a);a=Object.keys(a);for(var d=0;d<a.length;d++)"object"===typeof b[d]?(c.sources[d]=
{name:a[d],loop:void 0===b[d].loop?!0:b[d].loop,sound:void 0===b[d].sound?!0:b[d].loop,ffSize:b[d].ffSize},b[d]=b[d].path):c.sources[d]=a[d]}c.buffers=new h(c.context,b,function(){c.loaded.apply(c,arguments)});c.buffers.load()};e.prototype.loaded=function(){for(var a=this.buffers.bufferList.length,c=0;c<a;c++){var b=this.sources[c]||c,d=this.context.createAnalyser(),e=!0,f=!0,g=null;"object"===typeof b&&(f=b.loop,e=b.sound,g=b.ffSize,b=b.name);d.ffSize=g||this.ffSize;this.sources[b]=m.apply(this,
[b,c,f,e]);this.analyser[b]={a:d,d:new Uint8Array((g||this.ffSize)/2),getByteFrequencyData:function(){this.a.getByteFrequencyData(this.d);return this.d}};this.sources[b].connect(d);e&&this.sources[b].connect(this.context.destination);this.sources instanceof Array||delete this.sources[c]}this.isReady=!0;if("function"===typeof this.onLoaded)this.onLoaded()};e.prototype.startLoop=function(){this.isLoop||(this.isLoop=!0,this.enterFrame())};e.prototype.stopLoop=function(){this.isLoop=!1};e.prototype.enterFrame=
function(){var a=this;if(a.isLoop&&a.isReady){if("function"===typeof a.onEnterFrame)a.onEnterFrame();setTimeout(function(){a.enterFrame()},1E3/a.fps)}};e.prototype.play=function(a){var c,b,d;this.sources[a]?(c=this.state[a].index,b=this.sources[a].loop,d=this.state[a].sound,this.sources[a]=m.apply(this,[a,c,b,d]),this.sources[a].connect(this.analyser[a].a),d&&this.sources[a].connect(this.context.destination),this.sources[a].start(0),this.state[a].playing=!0):console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093")};
e.prototype.stop=function(a){this.sources[a]?(this.sources[a].stop(0),this.state[a].playing=!1):console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093")};e.prototype.isPlaying=function(a){if(this.state[a])return this.state[a].playing;console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093");return!1};j.prototype.sum=function(a){for(var c=a.length,b=0,d=0;d<c;d++)b+=a[d];return b};j.prototype.values=function(a){for(var c=
Object.keys(a),b=c.length,d=[],e=0;e<b;e++)d[e]=a[c[e]];return d};f.BufferLoader=h;f.AudioManager=e;f.Utils=new j})((this||0).self||global);