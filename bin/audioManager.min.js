(function(f){function k(){}function j(a,d,b){this.context=a;this.urlList=d;this.onload=b;this.bufferList=[];this.loadCount=0}function g(a){a=a||{};l||console.warn("not support user media");void 0===a.autoLoop&&(a.autoLoop=!0);this.context=null;this.sources={};this.analyser={};this.state={};this.fps=a.fps||60;this.autoLooop=!!a.autoLoop;this.ffSize=a.ffSize||2048;this.onEnterFrame=a.onEnterFrame||h;this.onInit=a.onInit||h;this.onMicInitSuccess=a.onMicInitSuccess||h;this.onMicInitFaild=a.onMicInitFaild||
h;this.onLoaded=a.onLoaded||h;this.useMicrophone=!!a.useMicrophone;this.isReady=this.isLoop=!1;this.buffers=null}function m(a,d,b,c){var e=this.context.createBufferSource();e.buffer=this.buffers.bufferList[d];e.loop=b;e.start=e.start||e.noteOn;e.stop=e.stop||e.noteOff;void 0===this.state[a]&&(this.state[a]={index:d,isReset:!0,sound:c,playing:!1,startTime:0,pauseTime:0,retryTime:0,offsetTime:0});return e}var h=function(){},l;l=!!(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||
navigator.mozGetUserMedia||navigator.msGetUserMedia);f.AudioContext=f.AudioContext||f.webkitAudioContext;f.requestAnimationFrame=f.requestAnimationFrame||f.mozRequestAnimationFrame||f.webkitRequestAnimationFrame||f.msRequestAnimationFrame;j.prototype.loadBuffer=function(a,d){var b=this,c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="arraybuffer";c.onload=function(){b.context.decodeAudioData(c.response,function(c){if(c){if(b.bufferList[d]=c,++b.loadCount===b.urlList.length)b.onload(b.bufferList)}else f.alert("error decoding file data: "+
a)},function(a){console.error("decodeAudioData error",a)})};c.onerror=function(){f.alert("BufferLoader: XHR error")};c.send()};j.prototype.load=function(){for(var a=0;a<this.urlList.length;++a)this.loadBuffer(this.urlList[a],a)};g.prototype.init=function(){var a=this;a.context=new f.AudioContext;if(a.useMicrophone)navigator.getUserMedia({audio:!0},function(d){a.micInitSuccess(d)},function(d){a.micInitFaild(d)});else{if("function"===typeof a.onInit)a.onInit();a.autoLooop&&(a.isReady=!0,a.startLoop())}return a};
g.prototype.micInitSuccess=function(a){var d=this.context.createAnalyser();d.ffSize=this.ffSize;this.sources.mic=this.context.createMediaStreamSource(a);this.analyser.mic={a:d,d:new Uint8Array(this.ffSize/2),getByteFrequencyData:function(){this.a.getByteFrequencyData(this.d);return this.d}};this.sources.mic.connect(d);if("function"===typeof this.onMicInitSuccess)this.onMicInitSuccess();this.isReady=!0;this.autoLooop&&(this.isLoop=!0,this.enterFrame())};g.prototype.micInitFaild=function(a){console.log("reject",
a);if("function"===typeof this.onMicInitFaild)this.onMicInitFaild()};g.prototype.load=function(a){var d=this,b=null,b=f.Utils;if(a instanceof Array)b=a,d.sources=[],d.analyser=[];else{d.sources={};d.analyser={};b=b.values(a);a=Object.keys(a);for(var c=0;c<a.length;c++)"object"===typeof b[c]?(d.sources[c]={name:a[c],loop:void 0===b[c].loop?!0:b[c].loop,sound:void 0===b[c].sound?!0:b[c].loop,ffSize:b[c].ffSize},b[c]=b[c].path):d.sources[c]=a[c]}d.buffers=new j(d.context,b,function(){d.loaded.apply(d,
arguments)});d.buffers.load()};g.prototype.loaded=function(){for(var a=this.buffers.bufferList.length,d=0;d<a;d++){var b=this.sources[d]||d,c=this.context.createAnalyser(),e=!0,f=!0,g=null;"object"===typeof b&&(f=b.loop,e=b.sound,g=b.ffSize,b=b.name);c.ffSize=g||this.ffSize;this.sources[b]=m.apply(this,[b,d,f,e]);this.analyser[b]={a:c,d:new Uint8Array((g||this.ffSize)/2),getByteFrequencyData:function(){this.a.getByteFrequencyData(this.d);return this.d}};this.sources[b].connect(c);e&&this.sources[b].connect(this.context.destination);
this.sources instanceof Array||delete this.sources[d]}this.isReady=!0;if("function"===typeof this.onLoaded)this.onLoaded()};g.prototype.startLoop=function(){this.isLoop||(this.isLoop=!0,this.enterFrame())};g.prototype.stopLoop=function(){this.isLoop=!1};g.prototype.enterFrame=function(){var a=this;if(a.isLoop&&a.isReady){if("function"===typeof a.onEnterFrame)a.onEnterFrame();60===a.fps?requestAnimationFrame(function(){a.enterFrame()}):setTimeout(function(){a.enterFrame()},1E3/a.fps)}};g.prototype.play=
function(a){var d=0,b=0,c=0,e=0;this.sources[a]?(d=this.state[a].index,b=this.sources[a].loop,c=this.state[a].sound,this.sources[a]=m.apply(this,[a,d,b,c]),this.sources[a].connect(this.analyser[a].a),c&&this.sources[a].connect(this.context.destination),this.state[a].isReset?(c=d=this.context.currentTime,e=0,this.state[a].startTime=d,this.state[a].retryTime=c,this.state[a].pauseTime=0,this.state[a].offsetTime=e,this.state[a].isReset=!1):(d=this.state[a].startTime,c=this.context.currentTime,b=this.state[a].pauseTime,
e=this.state[a].offsetTime,e+=c-b,this.state[a].retryTime=c,this.state[a].pauseTime=b,this.state[a].offsetTime=e),this.sources[a].start(0,c-d-e),this.state[a].playing=!0):console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093")};g.prototype.stop=function(a){this.sources[a]?(this.sources[a].stop(0),this.state[a].playing=!1,this.state[a].isReset=!0):console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093")};
g.prototype.pause=function(a){this.sources[a]?(this.sources[a].stop(0),this.state[a].pauseTime=this.context.currentTime,this.state[a].playing=!1):console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093")};g.prototype.isPlaying=function(a){if(this.state[a])return this.state[a].playing;console.warn("\u6307\u5b9a\u3057\u305fKEY\u306e\u97f3\u6e90\u306f\u5b58\u5728\u3057\u307e\u305b\u3093");return!1};k.prototype.sum=function(a){for(var d=a.length,b=0,c=0;c<
d;c++)b+=a[c];return b};k.prototype.values=function(a){for(var d=Object.keys(a),b=d.length,c=[],e=0;e<b;e++)c[e]=a[d[e]];return c};f.BufferLoader=j;f.AudioManager=g;f.Utils=new k})((this||0).self||global);